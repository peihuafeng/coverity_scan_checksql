name: Coverity Scan
# This workflow is triggered by a comment on a pull request containing the command run-coverity
on:
  workflow_dispatch:
  
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, reopened, synchronize, labeled]

jobs:
  # 1. 监听评论，把指令转换为标签
  comment_to_label:
    if: >
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, 'run-coverity')
    runs-on: ubuntu-latest
    permissions:
      issues: write          # 给 PR 加标签
      pull-requests: write
    steps:
      - name: Add trigger label
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.COVERITY_GITHUB_TOKEN }}
          script: |
            const label = 'ci:coverity';
            const prNumber = context.payload.issue.number;
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: [label],
            });

  # 2. 监听 PR 标签事件，正式执行 Coverity
  coverity_scan:
    runs-on: [self-hosted]
    permissions:
      contents: read
      pull-requests: write
      issues: write          # 运行完后移除标签
    env:
      BRIDGE_COVERITY_ARGS1: "--aggressiveness-level high --security --concurrency --webapp-security"
    steps:
      - name: Determine whether Coverity scan should run
        id: guard
        shell: bash
        run: |
          RUN=false
          REF=""

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ -n "${{ github.event.inputs.pull_number }}" ]]; then
              RUN=true
              REF="refs/pull/${{ github.event.inputs.pull_number }}/merge"
            fi
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            if [[ "${{ github.event.action }}" == "labeled" && "${{ github.event.label.name }}" == "ci:coverity" ]]; then
              RUN=true
              REF="refs/pull/${{ github.event.pull_request.number }}/merge"
            fi
          fi

          echo "run=$RUN" >> "$GITHUB_OUTPUT"
          echo "ref=$REF" >> "$GITHUB_OUTPUT"

      - name: Skip when scan not requested
        if: steps.guard.outputs.run != 'true'
        run: echo "Coverity scan was not requested for this event."

      - name: Checkout PR merge ref
        if: steps.guard.outputs.run == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.guard.outputs.ref }}

      - name: Configure CMake
        if: steps.guard.outputs.run == 'true'
        run: cmake -B build -G "Visual Studio 17 2022" -A x64

      - name: Coverity Scan
        if: steps.guard.outputs.run == 'true'
        uses: blackduck-inc/black-duck-security-scan@v2.1.0
        with:
          coverity_url: ${{ vars.COVERITY_URL }}
          coverity_user: ${{ secrets.COVERITY_USER }}
          coverity_passphrase: ${{ secrets.COVERITY_PASSPHRASE }}
          coverity_project_name: project_pr
          coverity_stream_name: stream_pr
          coverity_prComment_enabled: true
          github_token: ${{ secrets.COVERITY_GITHUB_TOKEN }}
          coverity_config_path: c:/coverity/coverity.yaml
          coverity_local: true
          coverity_install_directory: c:/coverity
          coverity_policy_view: 'Outstanding Issues'

      - name: Save Logs
        if: steps.guard.outputs.run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: bridge-logs
          path: ${{ github.workspace }}/.bridge
          include-hidden-files: true

      - name: Remove trigger label
        if: steps.guard.outputs.run == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const label = 'ci:coverity';
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              name: label,
            });
